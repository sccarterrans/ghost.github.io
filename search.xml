<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linux内核空间和用户空间</title>
      <link href="/Linux%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/"/>
      <url>/Linux%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<h3 id="Rings"><a href="#Rings" class="headerlink" title="Rings"></a>Rings</h3><p>在计算机科学中, <strong>分级保护域</strong>（英语：hierarchical protection domains），经常被叫作<strong>保护环</strong>（Protection Rings），又称<strong>环型保护</strong>（Rings Protection）、<strong>CPU环</strong>（CPU Rings），简称Rings。这是一种用来在发生故障时保护数据和功能，提升容错度，避免恶意操作 ，提升计算机安全的设计方式。</p><a id="more"></a><p>（来自维基百科）</p><p><img src="1.png" alt></p><p>工作在不同Ring中的对象对资源有不同的访问级别。Rings是从最高特权级（通常对应最小的数字）到最低特权级（最大的数字）排列的。在大多数操作系统中，Ring 0拥有最高特权，并且可以和最多的硬件直接交互（比如CPU，内存），同时内层Ring可以随便使用外层Ring的资源。</p><ul><li>Ring 0用于内核代码和驱动程序</li><li>Ring 1-2用于设备驱动程序</li><li>Ring 3用于非特权代码（几乎所有的用户程序都在这一级别）</li></ul><p>​          Rings的概念最早出现于x 86保护模式的设计中。Intel的初衷是让驱动存在于此Ring 1-2，但现代操作系统通常将驱动也放在Ring 0上。</p><h3 id="内核空间（Kernel-space-）与用户空间（User-space-）"><a href="#内核空间（Kernel-space-）与用户空间（User-space-）" class="headerlink" title="内核空间（Kernel space ）与用户空间（User space ）"></a>内核空间（Kernel space ）与用户空间（User space ）</h3><p>Kernel space 是 Linux 内核的运行空间（Ring0），User space 是用户程序的运行空间（Ring3）。通过分环隔离实现了操作系统的稳定性及可用性，即使用户的程序崩溃了，内核也不受影响。</p><p>下面描述用户空间与内核空间交互情况（来自互联网）：</p><p><img src="2.png" alt></p><p>运行在Kernel space的进程拥有CPU环最高权限，可以执行任意命令，调用系统的一切资源；User space 只能执行简单的运算，不能直接调用系统资源，必须通过系统接口（system call），才能向内核发出指令。</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">str = "my string" // 用户空间</span><br><span class="line">x = x + 2</span><br><span class="line">file.write(str) // 切换到内核空间</span><br><span class="line"></span><br><span class="line">y = x + 4 // 切换回用户空间</span><br></pre></td></tr></table></figure><p>上面代码中，第一行和第二行都是简单的赋值运算，在 User space 执行。第三行需要写入文件，就要切换到 Kernel space，因为用户不能直接写文件，必须通过内核安排。第四行又是赋值运算，就切换回 User space。</p><h3 id="内核空间（Kernel-space）与用户空间（User-space）空间分配"><a href="#内核空间（Kernel-space）与用户空间（User-space）空间分配" class="headerlink" title="内核空间（Kernel space）与用户空间（User space）空间分配"></a>内核空间（Kernel space）与用户空间（User space）空间分配</h3><p>对 32 位操作系统而言，它的寻址空间（虚拟地址空间，或叫线性地址空间）为 4G（2的32次方）。最高的 1G 字节(从虚拟地址 0xC0000000 到 0xFFFFFFFF)由内核使用，称为<strong>内核空间</strong>。而较低的 3G 字节(从虚拟地址 0x00000000 到 0xBFFFFFFF)由各个进程使用，称为<strong>用户空间</strong>。当进程运行在Ring0级别时被称为运行在<strong>内核态</strong>，而运行在Ring3级别时被称为<strong>用户态</strong>。</p><p>下面描述了每个进程寻址空间的分配情况（来自互联网）:</p><p><img src="3.png" alt></p><p><font color="#FF0000"><strong>内核空间是所有进程共享，用户空间是当前进程独享</strong></font></p><p>内核空间中存放的是<strong>内核代码</strong>和<strong>数据</strong>，而进程的用户空间中存放的是<strong>用户程序的代码</strong>和<strong>数据</strong>。不管是内核空间还是用户空间，它们都处于虚拟空间中。</p><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p>通过用户空间和内核空间的角度看一看Linux系统的架构(此图来自互联网)：</p><p><img src="4.png" alt></p><ul><li><p>当用户空间运行进程需要使用硬件资源或设备驱动时，通过调用内核空间暴露的接口（System Call）来申请资源或写入内核空间的高速页缓存</p></li><li><p>内核空间进程会实时调用（fsync）或由操作系统统一调度flusher内核线程将（write）数据同步到磁盘</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">以Mysql为例：</span><br><span class="line">innodb_flush_log_at_trx_commit 1 (fsync)</span><br><span class="line">事务提交时，进程会从用户空间应用缓存把数据copy到内核空间高速页缓存，并同时调用系统提供sync函数将数据写入磁盘</span><br><span class="line">innodb_flush_log_at_trx_commit 2 (write)</span><br><span class="line">事务提交时，进程会从用户空间应用缓存把数据copy到内核空间高速页缓存，等待flusher内核线程将数据写入磁盘</span><br></pre></td></tr></table></figure><p>从架构图可以看出内核空间进程可以操作设备程序（网卡程序、显卡程序）和硬件设备（键盘、鼠标、音箱）</p></li></ul><p>[参考链接]</p><ul><li><a href="https://www.cnblogs.com/sparkdev/p/8410350.html" target="_blank" rel="noopener">https://www.cnblogs.com/sparkdev/p/8410350.html</a></li><li><a href="http://www.ruanyifeng.com/blog/2016/12/user_space_vs_kernel_space.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/12/user_space_vs_kernel_space.html</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BA%A7%E4%BF%9D%E6%8A%A4%E5%9F%9F" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E5%88%86%E7%BA%A7%E4%BF%9D%E6%8A%A4%E5%9F%9F</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
